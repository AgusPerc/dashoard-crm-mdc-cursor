<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard CRM Interactivo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body class="min-h-full antialiased bg-stone-100 text-stone-900" style="font-family: Inter, ui-sans-serif, system-ui, -apple-system;">

  <!-- Header -->
  <header class="bg-white border-b border-stone-200">
    <div class="max-w-[1800px] mx-auto px-6 py-5">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-semibold tracking-tight text-stone-900">Dashboard CRM</h1>
          <p class="text-sm text-stone-500 mt-0.5">An√°lisis de leads y conversiones</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="clearFiltersBtn" class="hidden px-4 py-2 text-sm font-medium text-stone-600 bg-stone-100 rounded-xl hover:bg-stone-200 transition-colors" aria-label="Limpiar filtros">
            <span class="flex items-center gap-2">
              <i data-lucide="x" class="w-4 h-4"></i>
              Limpiar filtros
            </span>
          </button>
          <label for="csvFileInput" class="cursor-pointer px-4 py-2 text-sm font-medium text-white bg-stone-900 rounded-xl hover:bg-stone-800 transition-colors">
            <span class="flex items-center gap-2">
              <i data-lucide="upload" class="w-4 h-4"></i>
              Cargar CSV
            </span>
          </label>
          <input type="file" id="csvFileInput" accept=".csv" class="hidden" aria-label="Cargar archivo CSV">
        </div>
      </div>
    </div>
  </header>

  <div class="max-w-[1800px] mx-auto px-6 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- Left Sidebar - Filters -->
      <aside class="lg:col-span-3 space-y-5">
        <!-- Upload Zone -->
        <div id="uploadZone" class="relative border-2 border-dashed border-stone-300 rounded-2xl p-8 text-center bg-white hover:border-stone-400 hover:bg-stone-50 transition-all cursor-pointer">
          <div class="flex flex-col items-center gap-3">
            <div class="w-16 h-16 rounded-full bg-stone-100 flex items-center justify-center">
              <i data-lucide="file-up" class="w-8 h-8 text-stone-400"></i>
            </div>
            <div>
              <p class="text-sm font-medium text-stone-700">Arrastra tu CSV aqu√≠</p>
              <p class="text-xs text-stone-500 mt-1">o haz clic para seleccionar</p>
            </div>
          </div>
        </div>

        <!-- Filters Panel -->
        <div id="filtersPanel" class="hidden space-y-4">
          <!-- Date Range Filter -->
          <div class="bg-white rounded-2xl p-5 shadow-sm ring-1 ring-stone-200">
            <h3 class="text-sm font-semibold text-stone-900 mb-3 flex items-center gap-2">
              <i data-lucide="calendar" class="w-4 h-4"></i>
              Rango de fechas
            </h3>
            <div class="space-y-3">
              <div>
                <label class="text-xs text-stone-500 mb-1 block">Desde</label>
                <input type="date" id="dateFromInput" class="w-full px-3 py-2 text-sm border border-stone-300 rounded-lg focus:ring-2 focus:ring-stone-900 focus:border-transparent">
              </div>
              <div>
                <label class="text-xs text-stone-500 mb-1 block">Hasta</label>
                <input type="date" id="dateToInput" class="w-full px-3 py-2 text-sm border border-stone-300 rounded-lg focus:ring-2 focus:ring-stone-900 focus:border-transparent">
              </div>
            </div>
          </div>

          <!-- Canal Filter -->
          <div class="bg-white rounded-2xl p-5 shadow-sm ring-1 ring-stone-200">
            <h3 class="text-sm font-semibold text-stone-900 mb-3 flex items-center gap-2">
              <i data-lucide="radio" class="w-4 h-4"></i>
              Canal de adquisici√≥n
            </h3>
            <div id="canalFilterList" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Fase Filter -->
          <div class="bg-white rounded-2xl p-5 shadow-sm ring-1 ring-stone-200">
            <h3 class="text-sm font-semibold text-stone-900 mb-3 flex items-center gap-2">
              <i data-lucide="layers" class="w-4 h-4"></i>
              Fase
            </h3>
            <div id="faseFilterList" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Comercial Filter -->
          <div class="bg-white rounded-2xl p-5 shadow-sm ring-1 ring-stone-200">
            <h3 class="text-sm font-semibold text-stone-900 mb-3 flex items-center gap-2">
              <i data-lucide="user" class="w-4 h-4"></i>
              Comercial
            </h3>
            <div id="comercialFilterList" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="lg:col-span-9 space-y-6">
        <!-- Empty State -->
        <div id="emptyState" class="bg-white rounded-3xl p-12 text-center shadow-sm ring-1 ring-stone-200">
          <div class="flex flex-col items-center gap-4">
            <div class="w-20 h-20 rounded-full bg-stone-100 flex items-center justify-center">
              <i data-lucide="database" class="w-10 h-10 text-stone-400"></i>
            </div>
            <div>
              <h2 class="text-xl font-semibold text-stone-900">No hay datos cargados</h2>
              <p class="text-sm text-stone-500 mt-2">Carga un archivo CSV para comenzar a visualizar tus datos</p>
            </div>
          </div>
        </div>

        <!-- Dashboard Content (hidden initially) -->
        <div id="dashboardContent" class="hidden space-y-6">
          <!-- KPI Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            <!-- Total Leads -->
            <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-medium text-indigo-100">Total Leads</p>
                  <p id="kpiTotalLeads" class="text-4xl font-bold mt-2 tabular-nums">0</p>
                </div>
                <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                  <i data-lucide="users" class="w-6 h-6"></i>
                </div>
              </div>
            </div>

            <!-- % Concretados -->
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-medium text-emerald-100">Tasa de Conversi√≥n</p>
                  <p id="kpiConversionRate" class="text-4xl font-bold mt-2 tabular-nums">0%</p>
                </div>
                <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                  <i data-lucide="trending-up" class="w-6 h-6"></i>
                </div>
              </div>
            </div>

            <!-- Leads por d√≠a promedio -->
            <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl p-6 text-white shadow-lg">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-medium text-amber-100">Promedio por D√≠a</p>
                  <p id="kpiAvgPerDay" class="text-4xl font-bold mt-2 tabular-nums">0</p>
                </div>
                <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                  <i data-lucide="calendar-days" class="w-6 h-6"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Channel Donut Chart -->
            <div class="bg-white rounded-2xl p-6 shadow-sm ring-1 ring-stone-200">
              <div class="flex items-center justify-between mb-5">
                <div>
                  <h2 class="text-lg font-semibold text-stone-900">Leads por Canal</h2>
                  <p class="text-sm text-stone-500 mt-0.5">Distribuci√≥n por origen</p>
                </div>
                <div class="w-10 h-10 rounded-lg bg-stone-100 flex items-center justify-center">
                  <i data-lucide="pie-chart" class="w-5 h-5 text-stone-600"></i>
                </div>
              </div>
              <div class="relative h-80">
                <canvas id="channelChart"></canvas>
              </div>
            </div>

            <!-- Status Bar Chart -->
            <div class="bg-white rounded-2xl p-6 shadow-sm ring-1 ring-stone-200">
              <div class="flex items-center justify-between mb-5">
                <div>
                  <h2 class="text-lg font-semibold text-stone-900">Leads por Estatus</h2>
                  <p class="text-sm text-stone-500 mt-0.5">Resultado de gesti√≥n</p>
                </div>
                <div class="w-10 h-10 rounded-lg bg-stone-100 flex items-center justify-center">
                  <i data-lucide="bar-chart-3" class="w-5 h-5 text-stone-600"></i>
                </div>
              </div>
              <div class="relative h-80">
                <canvas id="statusChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Insights Section -->
          <div class="bg-white rounded-2xl p-6 shadow-sm ring-1 ring-stone-200">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-10 h-10 rounded-lg bg-stone-100 flex items-center justify-center">
                <i data-lucide="lightbulb" class="w-5 h-5 text-stone-600"></i>
              </div>
              <div>
                <h2 class="text-lg font-semibold text-stone-900">Insights</h2>
                <p class="text-sm text-stone-500">An√°lisis inteligente de tus datos</p>
              </div>
            </div>
            <ul id="insightsList" class="space-y-3"></ul>
          </div>
        </div>
      </main>

    </div>
  </div>

  <script>
    // ============================================================================
    // GLOBAL STATE & UTILITIES
    // ============================================================================
    let allData = [];
    let filteredData = [];
    let currentFilters = {
      canales: new Set(),
      fases: new Set(),
      comerciales: new Set(),
      dateFrom: null,
      dateTo: null
    };
    let charts = {
      channel: null,
      status: null
    };

    // Normalize string for comparison (lowercase, no accents)
    function normalizeKey(str) {
      if (!str) return '';
      return str.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim();
    }

    // Detect column by multiple possible names
    function detectColumn(headers, candidates) {
      const normalized = headers.map(h => normalizeKey(h));
      for (const candidate of candidates) {
        const idx = normalized.indexOf(normalizeKey(candidate));
        if (idx !== -1) return headers[idx];
      }
      return null;
    }

    // Parse date flexibly (DD/MM/YY, DD/MM/YYYY, YYYY-MM-DD, MM/DD/YYYY)
    function parseDateFlexible(val) {
      if (!val) return null;
      const str = String(val).trim();

      // Try DD/MM/YY or DD/MM/YYYY
      let match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (match) {
        let [, d, m, y] = match;
        if (y.length === 2) y = '20' + y;
        const date = new Date(y, m - 1, d);
        if (!isNaN(date)) return date;
      }

      // Try YYYY-MM-DD
      match = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (match) {
        const [, y, m, d] = match;
        const date = new Date(y, m - 1, d);
        if (!isNaN(date)) return date;
      }

      // Try MM/DD/YYYY
      match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (match) {
        const [, m, d, y] = match;
        const date = new Date(y, m - 1, d);
        if (!isNaN(date)) return date;
      }

      return null;
    }

    // Normalize status to standard categories
    function normalizeStatus(val) {
      if (!val) return 'Sin respuesta';
      const normalized = normalizeKey(val);

      if (normalized === 'concretado') return 'Concretado';
      if (normalized === 'sin respuesta' || normalized === 'sin_respuesta') return 'Sin respuesta';

      // Everything else maps to Cancelado
      return 'Cancelado';
    }

    // Format date as YYYY-MM-DD for input[type=date]
    function formatDateForInput(date) {
      if (!date) return '';
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // Animate number counter
    function animateNumber(element, target, duration = 800) {
      const start = 0;
      const startTime = performance.now();

      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = Math.floor(start + (target - start) * progress);
        element.textContent = current;

        if (progress < 1) {
          requestAnimationFrame(update);
        } else {
          element.textContent = target;
        }
      }

      requestAnimationFrame(update);
    }

    // ============================================================================
    // FILE UPLOAD & PARSING
    // ============================================================================
    function handleFileUpload(file) {
      if (!file) return;

      // First parse without headers to detect title rows
      Papa.parse(file, {
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
          findHeadersAndProcess(results.data);
        },
        error: function(error) {
          alert('Error al procesar el archivo CSV: ' + error.message);
        }
      });
    }

    function findHeadersAndProcess(rows) {
      if (rows.length < 2) {
        alert('‚ùå El archivo CSV no tiene suficientes datos');
        return;
      }

      // Find the row that contains the real headers
      // Look for rows containing key words like "Fecha", "Fase", "Canal", etc.
      let headerRowIndex = -1;
      const headerKeywords = ['fecha', 'fase', 'canal', 'comercial', 'como supo', 'motivo'];

      for (let i = 0; i < Math.min(5, rows.length); i++) {
        const row = rows[i];
        const rowText = row.join(' ').toLowerCase();

        // Check if this row contains multiple header keywords
        const matchCount = headerKeywords.filter(keyword => rowText.includes(keyword)).length;

        if (matchCount >= 3) {
          headerRowIndex = i;
          break;
        }
      }

      if (headerRowIndex === -1) {
        alert('‚ùå No se pudo detectar la fila de encabezados. Aseg√∫rate de que el CSV contenga columnas como: Fecha, Fase, Canal, Comercial, Motivo.');
        return;
      }

      // Extract headers and data
      const headers = rows[headerRowIndex].map(h => (h || '').trim());
      const dataRows = rows.slice(headerRowIndex + 1);

      // Convert to objects
      const data = dataRows
        .map(row => {
          const obj = {};
          headers.forEach((header, idx) => {
            obj[header] = row[idx] || '';
          });
          return obj;
        })
        .filter(row => {
          // Filter out completely empty rows
          return Object.values(row).some(val => val.trim() !== '');
        });

      processCSVData(data, headers);
    }

    function processCSVData(data, headers) {
      // Detect required columns
      const colFecha = detectColumn(headers, ['fecha', 'created_at', 'fecha_creacion', 'date']);
      const colCanal = detectColumn(headers, ['canal', 'canal_de_adquisicion', 'como_supo_de_nosotros', 'como supo de nosotros', 'source', 'origen']);
      const colFase = detectColumn(headers, ['fase', 'stage', 'etapa']);
      const colComercial = detectColumn(headers, ['comercial', 'vendedor', 'owner', 'ejecutivo']);
      const colEstatus = detectColumn(headers, ['motivo por que no se concreto', 'motivo_por_que_no_se_concreto', 'estatus', 'status', 'estado']);

      // Validate required columns
      if (!colFecha || !colCanal || !colFase || !colComercial || !colEstatus) {
        const missing = [];
        if (!colFecha) missing.push('Fecha');
        if (!colCanal) missing.push('Canal/Como supo de nosotros');
        if (!colFase) missing.push('Fase');
        if (!colComercial) missing.push('Comercial');
        if (!colEstatus) missing.push('Estatus/Motivo');

        alert(`‚ùå Faltan columnas requeridas:\n\n${missing.join('\n')}\n\nColumnas detectadas:\n${headers.filter(h => h).join(', ')}`);
        return;
      }

      // Parse and clean data
      allData = data
        .map(row => {
          const fecha = parseDateFlexible(row[colFecha]);
          if (!fecha) return null;

          return {
            fecha: fecha,
            canal: (row[colCanal] || '').trim() || 'Sin especificar',
            fase: (row[colFase] || '').trim() || 'Sin especificar',
            comercial: (row[colComercial] || '').trim() || 'Sin especificar',
            estatus: normalizeStatus(row[colEstatus])
          };
        })
        .filter(row => row !== null);

      if (allData.length === 0) {
        alert('‚ùå No se encontraron filas v√°lidas en el CSV');
        return;
      }

      // Initialize filters and dashboard
      initializeFilters();
      applyFilters();
      showDashboard();
    }

    // ============================================================================
    // FILTER MANAGEMENT
    // ============================================================================
    function initializeFilters() {
      // Reset filters
      currentFilters = {
        canales: new Set(),
        fases: new Set(),
        comerciales: new Set(),
        dateFrom: null,
        dateTo: null
      };

      // Get unique values
      const canales = [...new Set(allData.map(d => d.canal))].sort();
      const fases = [...new Set(allData.map(d => d.fase))].sort();
      const comerciales = [...new Set(allData.map(d => d.comercial))].sort();

      // Render filter chips
      renderFilterChips('canalFilterList', canales, 'canales');
      renderFilterChips('faseFilterList', fases, 'fases');
      renderFilterChips('comercialFilterList', comerciales, 'comerciales');

      // Set date range to full data range
      const dates = allData.map(d => d.fecha).sort((a, b) => a - b);
      const minDate = dates[0];
      const maxDate = dates[dates.length - 1];

      document.getElementById('dateFromInput').value = formatDateForInput(minDate);
      document.getElementById('dateToInput').value = formatDateForInput(maxDate);

      currentFilters.dateFrom = minDate;
      currentFilters.dateTo = maxDate;
    }

    function renderFilterChips(containerId, values, filterKey) {
      const container = document.getElementById(containerId);
      container.innerHTML = values.map(value => `
        <button
          class="filter-chip px-3 py-1.5 text-xs font-medium rounded-lg border-2 transition-all
                 border-stone-300 text-stone-700 hover:border-stone-400 hover:bg-stone-50"
          data-filter="${filterKey}"
          data-value="${value}"
          aria-label="Filtrar por ${value}"
        >
          ${value}
        </button>
      `).join('');

      // Add click handlers
      container.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => toggleFilterChip(chip));
      });
    }

    function toggleFilterChip(chip) {
      const filterKey = chip.dataset.filter;
      const value = chip.dataset.value;

      if (currentFilters[filterKey].has(value)) {
        currentFilters[filterKey].delete(value);
        chip.classList.remove('border-indigo-500', 'bg-indigo-50', 'text-indigo-700');
        chip.classList.add('border-stone-300', 'text-stone-700');
      } else {
        currentFilters[filterKey].add(value);
        chip.classList.remove('border-stone-300', 'text-stone-700');
        chip.classList.add('border-indigo-500', 'bg-indigo-50', 'text-indigo-700');
      }

      applyFilters();
      updateClearButtonVisibility();
    }

    function applyFilters() {
      filteredData = allData.filter(row => {
        // Canal filter
        if (currentFilters.canales.size > 0 && !currentFilters.canales.has(row.canal)) {
          return false;
        }

        // Fase filter
        if (currentFilters.fases.size > 0 && !currentFilters.fases.has(row.fase)) {
          return false;
        }

        // Comercial filter
        if (currentFilters.comerciales.size > 0 && !currentFilters.comerciales.has(row.comercial)) {
          return false;
        }

        // Date range filter
        if (currentFilters.dateFrom && row.fecha < currentFilters.dateFrom) {
          return false;
        }
        if (currentFilters.dateTo && row.fecha > currentFilters.dateTo) {
          return false;
        }

        return true;
      });

      updateDashboard();
    }

    function clearAllFilters() {
      // Clear all filter sets
      currentFilters.canales.clear();
      currentFilters.fases.clear();
      currentFilters.comerciales.clear();

      // Reset date range
      const dates = allData.map(d => d.fecha).sort((a, b) => a - b);
      currentFilters.dateFrom = dates[0];
      currentFilters.dateTo = dates[dates.length - 1];

      document.getElementById('dateFromInput').value = formatDateForInput(currentFilters.dateFrom);
      document.getElementById('dateToInput').value = formatDateForInput(currentFilters.dateTo);

      // Reset chip styles
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('border-indigo-500', 'bg-indigo-50', 'text-indigo-700');
        chip.classList.add('border-stone-300', 'text-stone-700');
      });

      applyFilters();
      updateClearButtonVisibility();
    }

    function updateClearButtonVisibility() {
      const hasActiveFilters =
        currentFilters.canales.size > 0 ||
        currentFilters.fases.size > 0 ||
        currentFilters.comerciales.size > 0;

      const btn = document.getElementById('clearFiltersBtn');
      if (hasActiveFilters) {
        btn.classList.remove('hidden');
      } else {
        btn.classList.add('hidden');
      }
    }

    // ============================================================================
    // DASHBOARD UPDATE
    // ============================================================================
    function updateDashboard() {
      updateKPIs();
      updateChannelChart();
      updateStatusChart();
      renderInsights();
    }

    function updateKPIs() {
      const total = filteredData.length;
      const concretados = filteredData.filter(d => d.estatus === 'Concretado').length;
      const conversionRate = total > 0 ? ((concretados / total) * 100).toFixed(1) : 0;

      // Calculate average per day
      const dates = filteredData.map(d => d.fecha).sort((a, b) => a - b);
      let avgPerDay = 0;
      if (dates.length > 0) {
        const minDate = dates[0];
        const maxDate = dates[dates.length - 1];
        const daysDiff = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1);
        avgPerDay = (total / daysDiff).toFixed(1);
      }

      // Animate KPIs
      const totalEl = document.getElementById('kpiTotalLeads');
      const conversionEl = document.getElementById('kpiConversionRate');
      const avgEl = document.getElementById('kpiAvgPerDay');

      animateNumber(totalEl, total);
      conversionEl.textContent = conversionRate + '%';
      avgEl.textContent = avgPerDay;
    }

    function updateChannelChart() {
      const ctx = document.getElementById('channelChart');

      // Count by channel
      const channelCounts = {};
      filteredData.forEach(row => {
        channelCounts[row.canal] = (channelCounts[row.canal] || 0) + 1;
      });

      // Sort by count descending
      const sorted = Object.entries(channelCounts)
        .sort((a, b) => b[1] - a[1]);

      const labels = sorted.map(([canal]) => canal);
      const data = sorted.map(([, count]) => count);
      const total = data.reduce((sum, val) => sum + val, 0);

      // Color palette
      const colors = [
        '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
        '#3b82f6', '#ef4444', '#14b8a6', '#f97316', '#84cc16'
      ];

      // Destroy previous chart
      if (charts.channel) {
        charts.channel.destroy();
      }

      // Create donut chart
      charts.channel = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: { size: 12, family: 'Inter' },
                color: '#44403c'
              }
            },
            tooltip: {
              backgroundColor: '#1c1917',
              titleColor: '#fff',
              bodyColor: '#e7e5e4',
              padding: 12,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const count = context.parsed;
                  const percentage = ((count / total) * 100).toFixed(1);
                  return ` ${context.label}: ${count} (${percentage}%)`;
                }
              }
            },
            datalabels: {
              color: '#fff',
              font: { size: 11, weight: 'bold', family: 'Inter' },
              formatter: function(value, context) {
                const percentage = ((value / total) * 100).toFixed(1);
                return `${value}\n${percentage}%`;
              },
              textAlign: 'center'
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function updateStatusChart() {
      const ctx = document.getElementById('statusChart');

      // Count by status
      const statusOrder = ['Concretado', 'Cancelado', 'Sin respuesta'];
      const statusCounts = {
        'Concretado': 0,
        'Cancelado': 0,
        'Sin respuesta': 0
      };

      filteredData.forEach(row => {
        statusCounts[row.estatus] = (statusCounts[row.estatus] || 0) + 1;
      });

      const labels = statusOrder;
      const data = statusOrder.map(status => statusCounts[status]);

      // Colors matching status meaning
      const colors = {
        'Concretado': '#10b981',
        'Cancelado': '#ef4444',
        'Sin respuesta': '#f59e0b'
      };

      // Destroy previous chart
      if (charts.status) {
        charts.status.destroy();
      }

      // Create bar chart
      charts.status = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: labels.map(label => colors[label]),
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: { color: '#f5f5f4', drawBorder: false },
              ticks: { color: '#78716c', font: { size: 12, family: 'Inter' } }
            },
            y: {
              beginAtZero: true,
              grid: { color: '#f5f5f4', drawBorder: false },
              ticks: {
                color: '#78716c',
                font: { size: 12, family: 'Inter' },
                precision: 0
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1c1917',
              titleColor: '#fff',
              bodyColor: '#e7e5e4',
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return ` ${context.parsed.y} leads`;
                }
              }
            },
            datalabels: {
              display: false
            }
          }
        }
      });
    }

    function renderInsights() {
      const insights = [];

      // 1. Top canal by volume
      const channelCounts = {};
      filteredData.forEach(row => {
        channelCounts[row.canal] = (channelCounts[row.canal] || 0) + 1;
      });
      const topChannel = Object.entries(channelCounts)
        .sort((a, b) => b[1] - a[1])[0];

      if (topChannel) {
        const [canal, count] = topChannel;
        const percentage = ((count / filteredData.length) * 100).toFixed(1);
        insights.push({
          icon: 'üèÜ',
          text: `<strong>${canal}</strong> es el canal con mayor volumen, generando <strong>${count} leads</strong> (${percentage}% del total).`
        });
      }

      // 2. Conversion rate
      const concretados = filteredData.filter(d => d.estatus === 'Concretado').length;
      const conversionRate = filteredData.length > 0
        ? ((concretados / filteredData.length) * 100).toFixed(1)
        : 0;
      insights.push({
        icon: 'üìà',
        text: `La tasa de conversi√≥n actual es del <strong>${conversionRate}%</strong> con <strong>${concretados} leads concretados</strong> de ${filteredData.length} totales.`
      });

      // 3. Top comercial by concretados
      const comercialStats = {};
      filteredData.forEach(row => {
        if (!comercialStats[row.comercial]) {
          comercialStats[row.comercial] = { total: 0, concretados: 0 };
        }
        comercialStats[row.comercial].total++;
        if (row.estatus === 'Concretado') {
          comercialStats[row.comercial].concretados++;
        }
      });

      const topComercial = Object.entries(comercialStats)
        .filter(([name]) => name !== 'Sin especificar')
        .sort((a, b) => b[1].concretados - a[1].concretados)[0];

      if (topComercial) {
        const [name, stats] = topComercial;
        const rate = stats.total > 0 ? ((stats.concretados / stats.total) * 100).toFixed(1) : 0;
        insights.push({
          icon: 'üßë‚Äçüíº',
          text: `<strong>${name}</strong> lidera en concretados con <strong>${stats.concretados} leads</strong> y una tasa de conversi√≥n del ${rate}%.`
        });
      }

      // 4. Fase with most cancelados
      const faseCancelados = {};
      filteredData
        .filter(d => d.estatus === 'Cancelado')
        .forEach(row => {
          faseCancelados[row.fase] = (faseCancelados[row.fase] || 0) + 1;
        });

      const topFaseCancelado = Object.entries(faseCancelados)
        .sort((a, b) => b[1] - a[1])[0];

      if (topFaseCancelado) {
        const [fase, count] = topFaseCancelado;
        const totalCancelados = filteredData.filter(d => d.estatus === 'Cancelado').length;
        const percentage = totalCancelados > 0 ? ((count / totalCancelados) * 100).toFixed(1) : 0;
        insights.push({
          icon: '‚ö†Ô∏è',
          text: `La fase <strong>${fase}</strong> concentra la mayor cantidad de cancelaciones con <strong>${count} leads</strong> (${percentage}% del total cancelado).`
        });
      }

      // Render insights
      const container = document.getElementById('insightsList');
      container.innerHTML = insights.map(insight => `
        <li class="flex gap-3 p-4 rounded-xl bg-stone-50 border border-stone-200">
          <span class="text-2xl flex-shrink-0">${insight.icon}</span>
          <p class="text-sm text-stone-700 leading-relaxed">${insight.text}</p>
        </li>
      `).join('');
    }

    function showDashboard() {
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('dashboardContent').classList.remove('hidden');
      document.getElementById('filtersPanel').classList.remove('hidden');
      lucide.createIcons(); // Re-render icons
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
      // File input
      document.getElementById('csvFileInput').addEventListener('change', (e) => {
        handleFileUpload(e.target.files[0]);
      });

      // Upload zone click
      document.getElementById('uploadZone').addEventListener('click', () => {
        document.getElementById('csvFileInput').click();
      });

      // Drag & drop
      const uploadZone = document.getElementById('uploadZone');
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('border-indigo-500', 'bg-indigo-50');
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('border-indigo-500', 'bg-indigo-50');
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('border-indigo-500', 'bg-indigo-50');
        handleFileUpload(e.dataTransfer.files[0]);
      });

      // Date range inputs
      document.getElementById('dateFromInput').addEventListener('change', (e) => {
        const date = new Date(e.target.value);
        if (!isNaN(date)) {
          currentFilters.dateFrom = date;
          applyFilters();
        }
      });

      document.getElementById('dateToInput').addEventListener('change', (e) => {
        const date = new Date(e.target.value);
        if (!isNaN(date)) {
          // Set to end of day
          date.setHours(23, 59, 59, 999);
          currentFilters.dateTo = date;
          applyFilters();
        }
      });

      // Clear filters button
      document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);

      // Initialize Lucide icons
      lucide.createIcons();
    });

    // ============================================================================
    // TEST DATA (commented for easy testing)
    // ============================================================================
    /*
    const testCSV = `Fecha,Nombre del posible cliente,Como supo de nosotros,Fase,Motivo por que no se concreto,COMERCIAL
11/09/25,Andrea Canales,Referidos,Cotizado,Cancelado,Alejandra Vargas
11/09/25,Berenice V√°zquez,Google,Cotizado,Fuera de Presupuesto,Ariel Morones
14/09/25,Marcos Ushdi,Referidos,Concretado,Concretado,Alejandra Vargas
15/09/25,Berenice Mart√≠nez,Google,Concretado,Concretado,Ariel Morones
22/09/25,Leobardo Brizuela,Hosp Espa√±ol,Concretado,Concretado,Ariel Morones
30/09/25,Juan Pablo Cabrera,Referidos,Concretado,Concretado,Alejandra Vargas
05/10/25,Mariana Varela,Hosp Espa√±ol,Concretado,Concretado,Sofia Platas
08/10/25,Daniel Garay,Ex Cliente,Concretado,Concretado,Alejandra Vargas
16/10/25,Virlette Rodriguez,Hosp Satelite,Concretado,Concretado,Sofia Platas
20/10/25,Uriel Corona,Referidos,Concretado,Concretado,Alejandra Vargas
22/10/25,Rosemary Eustace,Referidos,Concretado,Concretado,Alejandra Vargas
25/10/25,Mayela Cervantes,Referidos,Concretado,Concretado,Alejandra Vargas
26/10/25,Eduardo Amizahua,Hosp Espa√±ol,Concretado,Concretado,Alejandra Vargas
27/10/25,Ricardo Moctezuma,Hosp Satelite,Concretado,Concretado,Sofia Platas
27/10/25,Bego√±a Hevia,Referidos,Concretado,Concretado,Sofia Platas
29/10/25,Laura Elena Fern√°ndez,ATEND,Concretado,Concretado,Sofia Platas
30/10/25,Daniel Varon Shirino,ATEND,Concretado,Concretado,Sofia Platas`;

    // Uncomment to test with sample data:
    // Papa.parse(testCSV, {
    //   header: true,
    //   skipEmptyLines: true,
    //   complete: function(results) {
    //     processCSVData(results.data, results.meta.fields);
    //   }
    // });
    */
  </script>

</body>
</html>
