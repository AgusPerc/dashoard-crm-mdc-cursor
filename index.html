<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard CRM ‚Äî Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

    /* Glass Morphism Effects */
    .glass-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border: 0.5px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 0 0.5px rgba(255, 255, 255, 0.03) inset, 0 20px 40px rgba(0, 0, 0, 0.6);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .glass-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 0 0 0.5px rgba(255, 255, 255, 0.08) inset, 0 30px 60px rgba(0, 0, 0, 0.7);
      border-color: rgba(255, 255, 255, 0.15);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
    }

    .glass-sidebar {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
      backdrop-filter: blur(60px) saturate(160%);
      -webkit-backdrop-filter: blur(60px) saturate(160%);
      border-right: 0.5px solid rgba(255, 255, 255, 0.1);
    }

    .glass-input {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border: 0.5px solid rgba(255, 255, 255, 0.15);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .glass-input:focus-within {
      border-color: rgba(99, 102, 241, 0.5);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
    }

    .icon-container {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 0.5px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .icon-container:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.12) 100%);
      transform: scale(1.05);
    }

    /* Animations */
    @keyframes fade-in {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    @keyframes slide-up {
      0% { opacity: 0; transform: translateY(30px) scale(0.96); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes slide-in-left {
      0% { opacity: 0; transform: translateX(-40px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    @keyframes slide-in-right {
      0% { opacity: 0; transform: translateX(40px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    .animate-fade-in { animation: fade-in 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .animate-slide-up { animation: slide-up 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .animate-slide-left { animation: slide-in-left 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .animate-slide-right { animation: slide-in-right 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

    /* Light mode overrides */
    html:not(.dark) .glass-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
      border: 0.5px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 0 0 0.5px rgba(0, 0, 0, 0.03) inset, 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    html:not(.dark) .glass-card:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.8) 100%);
      box-shadow: 0 0 0 0.5px rgba(0, 0, 0, 0.05) inset, 0 30px 60px rgba(0, 0, 0, 0.15);
    }

    html:not(.dark) .glass-sidebar {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.8) 100%);
      border-right: 0.5px solid rgba(0, 0, 0, 0.1);
    }

    html:not(.dark) ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-gray-800 dark:from-gray-900 dark:via-slate-900 dark:to-gray-800 bg-stone-50 text-white dark:text-white text-stone-900 antialiased overflow-x-hidden">

  <!-- Background Static Gradient -->
  <div class="fixed inset-0 -z-20">
    <div class="absolute inset-0 bg-gradient-to-br from-gray-900/50 via-slate-900/60 to-gray-800/70 dark:from-gray-900/50 dark:via-slate-900/60 dark:to-gray-800/70 from-stone-100/50 via-stone-200/60 to-stone-300/70"></div>
    <div class="absolute inset-0 opacity-30">
      <div class="absolute top-1/4 right-1/4 w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl"></div>
      <div class="absolute bottom-1/3 left-1/4 w-96 h-96 bg-purple-500/20 rounded-full blur-3xl"></div>
    </div>
  </div>

  <!-- Quick Period Filters -->
  <div class="flex flex-wrap justify-center gap-3 pt-8 px-4 text-sm font-medium animate-fade-in relative z-10">
    <button id="periodToday" class="period-filter px-5 py-2.5 rounded-full glass-card hover:scale-105 transition-transform duration-300">Hoy</button>
    <button id="period7Days" class="period-filter px-5 py-2.5 rounded-full glass-card hover:scale-105 transition-transform duration-300">√öltimos 7 d√≠as</button>
    <button id="period30Days" class="period-filter px-5 py-2.5 rounded-full glass-card hover:scale-105 transition-transform duration-300">√öltimos 30 d√≠as</button>
    <button id="periodThisMonth" class="period-filter px-5 py-2.5 rounded-full glass-card hover:scale-105 transition-transform duration-300">Este mes</button>
    <button id="periodAll" class="period-filter px-5 py-2.5 rounded-full backdrop-blur-sm border border-blue-500/30 bg-blue-600/20 text-blue-200 dark:text-blue-200 text-blue-600 hover:scale-105 hover:bg-blue-600/30 transition-all duration-300">Todo</button>
  </div>

  <!-- Main Container -->
  <div class="max-w-[1800px] mx-auto px-6 py-8">
    <!-- Header -->
    <header class="mb-8 flex items-center justify-between animate-slide-up">
      <div class="flex items-center gap-4">
        <div class="icon-container p-3 rounded-xl">
          <i data-lucide="bar-chart-3" class="w-8 h-8 text-blue-400"></i>
        </div>
        <div>
          <h1 class="text-3xl font-bold tracking-tight">Dashboard CRM</h1>
          <p class="text-sm text-gray-400 dark:text-gray-400 text-stone-600 mt-0.5">An√°lisis de leads y conversiones en tiempo real</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="themeToggle" class="glass-card p-3 rounded-xl hover:scale-105 transition-all duration-200" aria-label="Cambiar tema">
          <i data-lucide="moon" class="w-5 h-5 dark-icon hidden dark:block"></i>
          <i data-lucide="sun" class="w-5 h-5 light-icon block dark:hidden text-stone-700"></i>
        </button>
        <button id="clearFiltersBtn" class="hidden glass-card px-4 py-2.5 rounded-xl text-sm font-medium hover:scale-105 transition-all duration-200" aria-label="Limpiar filtros">
          <span class="flex items-center gap-2">
            <i data-lucide="x" class="w-4 h-4"></i>
            Limpiar filtros
          </span>
        </button>
        <label for="csvFileInput" class="cursor-pointer px-4 py-2.5 text-sm font-medium bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl hover:scale-105 transition-all duration-200 shadow-lg text-white">
          <span class="flex items-center gap-2">
            <i data-lucide="upload" class="w-4 h-4"></i>
            Cargar CSV
          </span>
        </label>
        <input type="file" id="csvFileInput" accept=".csv" class="hidden" aria-label="Cargar archivo CSV">
      </div>
    </header>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- Sidebar Filters -->
      <aside class="lg:col-span-3 space-y-5 animate-slide-left">

        <!-- Upload Zone -->
        <div id="uploadZone" class="relative glass-card rounded-2xl p-8 text-center cursor-pointer transition-all duration-300 hover:scale-[1.02]">
          <div class="flex flex-col items-center gap-3">
            <div class="icon-container w-16 h-16 rounded-full flex items-center justify-center">
              <i data-lucide="file-up" class="w-8 h-8 text-blue-400"></i>
            </div>
            <div>
              <p class="text-sm font-medium">Arrastra tu CSV aqu√≠</p>
              <p class="text-xs text-gray-400 dark:text-gray-400 text-stone-600 mt-1">o haz clic para seleccionar</p>
            </div>
          </div>
        </div>

        <!-- Filters Panel -->
        <div id="filtersPanel" class="hidden space-y-4">

          <!-- Date Range Filter -->
          <div class="glass-card rounded-2xl p-5">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
              <i data-lucide="calendar" class="w-4 h-4 text-blue-400"></i>
              Rango de fechas
            </h3>
            <div class="space-y-3">
              <div>
                <label class="text-xs text-gray-400 dark:text-gray-400 text-stone-600 mb-1 block">Desde</label>
                <input type="date" id="dateFromInput" class="glass-input w-full px-3 py-2 text-sm rounded-lg outline-none">
              </div>
              <div>
                <label class="text-xs text-gray-400 dark:text-gray-400 text-stone-600 mb-1 block">Hasta</label>
                <input type="date" id="dateToInput" class="glass-input w-full px-3 py-2 text-sm rounded-lg outline-none">
              </div>
            </div>
          </div>

          <!-- Canal Filter -->
          <div class="glass-card rounded-2xl p-5">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
              <i data-lucide="radio" class="w-4 h-4 text-purple-400"></i>
              Canal de adquisici√≥n
            </h3>
            <div id="canalFilterList" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Fase Filter -->
          <div class="glass-card rounded-2xl p-5">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
              <i data-lucide="layers" class="w-4 h-4 text-emerald-400"></i>
              Fase
            </h3>
            <div id="faseFilterList" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Comercial Filter -->
          <div class="glass-card rounded-2xl p-5">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
              <i data-lucide="user" class="w-4 h-4 text-amber-400"></i>
              Comercial
            </h3>
            <div id="comercialFilterList" class="flex flex-wrap gap-2"></div>
          </div>

        </div>
      </aside>

      <!-- Main Content -->
      <main class="lg:col-span-9 space-y-6 animate-slide-right">

        <!-- Empty State -->
        <div id="emptyState" class="glass-card rounded-3xl p-12 text-center">
          <div class="flex flex-col items-center gap-4">
            <div class="icon-container w-20 h-20 rounded-full flex items-center justify-center">
              <i data-lucide="database" class="w-10 h-10 text-blue-400"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold">No hay datos cargados</h2>
              <p class="text-sm text-gray-400 dark:text-gray-400 text-stone-600 mt-2">Carga un archivo CSV para comenzar a visualizar tus datos</p>
            </div>
          </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden space-y-6">

          <!-- KPI Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-5">

            <!-- Total Leads -->
            <div class="glass-card rounded-2xl p-6 group hover:scale-[1.02] transition-all duration-300">
              <div class="flex items-start justify-between mb-4">
                <div class="icon-container p-3 rounded-xl group-hover:scale-110 transition-transform duration-300">
                  <i data-lucide="users" class="w-6 h-6 text-indigo-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-400 dark:text-gray-400 text-stone-600 mb-1">Total Leads</p>
              <p id="kpiTotalLeads" class="text-4xl font-bold tabular-nums">0</p>
            </div>

            <!-- Tasa de Conversi√≥n -->
            <div class="glass-card rounded-2xl p-6 group hover:scale-[1.02] transition-all duration-300">
              <div class="flex items-start justify-between mb-4">
                <div class="icon-container p-3 rounded-xl group-hover:scale-110 transition-transform duration-300">
                  <i data-lucide="trending-up" class="w-6 h-6 text-emerald-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-400 dark:text-gray-400 text-stone-600 mb-1">Tasa de Conversi√≥n</p>
              <p id="kpiConversionRate" class="text-4xl font-bold tabular-nums">0%</p>
            </div>

            <!-- Promedio por D√≠a -->
            <div class="glass-card rounded-2xl p-6 group hover:scale-[1.02] transition-all duration-300">
              <div class="flex items-start justify-between mb-4">
                <div class="icon-container p-3 rounded-xl group-hover:scale-110 transition-transform duration-300">
                  <i data-lucide="calendar-days" class="w-6 h-6 text-amber-400"></i>
                </div>
              </div>
              <p class="text-sm text-gray-400 dark:text-gray-400 text-stone-600 mb-1">Promedio por D√≠a</p>
              <p id="kpiAvgPerDay" class="text-4xl font-bold tabular-nums">0</p>
            </div>

          </div>

          <!-- Charts Row -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Channel Donut Chart -->
            <div class="glass-card rounded-2xl p-6">
              <div class="flex items-center justify-between mb-5">
                <div>
                  <h2 class="text-lg font-semibold">Leads por Canal</h2>
                  <p class="text-sm text-gray-400 dark:text-gray-400 text-stone-600 mt-0.5">Distribuci√≥n por origen</p>
                </div>
                <div class="icon-container p-2.5 rounded-lg">
                  <i data-lucide="pie-chart" class="w-5 h-5 text-purple-400"></i>
                </div>
              </div>
              <div class="relative h-80">
                <canvas id="channelChart"></canvas>
              </div>
            </div>

            <!-- Status Bar Chart -->
            <div class="glass-card rounded-2xl p-6">
              <div class="flex items-center justify-between mb-5">
                <div>
                  <h2 class="text-lg font-semibold">Leads por Estatus</h2>
                  <p class="text-sm text-gray-400 dark:text-gray-400 text-stone-600 mt-0.5">Resultado de gesti√≥n</p>
                </div>
                <div class="icon-container p-2.5 rounded-lg">
                  <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-400"></i>
                </div>
              </div>
              <div class="relative h-80">
                <canvas id="statusChart"></canvas>
              </div>
            </div>

          </div>

          <!-- Insights Section -->
          <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center gap-3 mb-5">
              <div class="icon-container p-2.5 rounded-lg">
                <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-400"></i>
              </div>
              <div>
                <h2 class="text-lg font-semibold">Insights</h2>
                <p class="text-sm text-gray-400 dark:text-gray-400 text-stone-600">An√°lisis inteligente de tus datos</p>
              </div>
            </div>
            <ul id="insightsList" class="space-y-3"></ul>
          </div>

        </div>
      </main>

    </div>
  </div>

  <script>
    // ============================================================================
    // THEME MANAGEMENT
    // ============================================================================
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      if (savedTheme === 'light') {
        document.documentElement.classList.remove('dark');
      } else {
        document.documentElement.classList.add('dark');
      }
    }

    function toggleTheme() {
      const html = document.documentElement;
      if (html.classList.contains('dark')) {
        html.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        html.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
      // Recreate charts with new colors
      if (charts.channel) {
        updateChannelChart();
        updateStatusChart();
      }
    }

    // ============================================================================
    // GLOBAL STATE & UTILITIES
    // ============================================================================
    let allData = [];
    let filteredData = [];
    let currentFilters = {
      canales: new Set(),
      fases: new Set(),
      comerciales: new Set(),
      dateFrom: null,
      dateTo: null
    };
    let charts = {
      channel: null,
      status: null
    };

    function normalizeKey(str) {
      if (!str) return '';
      return str.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim();
    }

    function detectColumn(headers, candidates) {
      const normalized = headers.map(h => normalizeKey(h));
      for (const candidate of candidates) {
        const idx = normalized.indexOf(normalizeKey(candidate));
        if (idx !== -1) return headers[idx];
      }
      return null;
    }

    function parseDateFlexible(val) {
      if (!val) return null;
      const str = String(val).trim();

      let match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (match) {
        let [, d, m, y] = match;
        if (y.length === 2) y = '20' + y;
        const date = new Date(y, m - 1, d);
        if (!isNaN(date)) return date;
      }

      match = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (match) {
        const [, y, m, d] = match;
        const date = new Date(y, m - 1, d);
        if (!isNaN(date)) return date;
      }

      match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (match) {
        const [, m, d, y] = match;
        const date = new Date(y, m - 1, d);
        if (!isNaN(date)) return date;
      }

      return null;
    }

    function normalizeStatus(val) {
      if (!val) return 'Sin respuesta';
      const normalized = normalizeKey(val);
      if (normalized === 'concretado') return 'Concretado';
      if (normalized === 'sin respuesta' || normalized === 'sin_respuesta') return 'Sin respuesta';
      return 'Cancelado';
    }

    function formatDateForInput(date) {
      if (!date) return '';
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function animateNumber(element, target, duration = 800) {
      const start = 0;
      const startTime = performance.now();
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = Math.floor(start + (target - start) * progress);
        element.textContent = current;
        if (progress < 1) {
          requestAnimationFrame(update);
        } else {
          element.textContent = target;
        }
      }
      requestAnimationFrame(update);
    }

    // ============================================================================
    // FILE UPLOAD & PARSING
    // ============================================================================
    function handleFileUpload(file) {
      if (!file) return;
      Papa.parse(file, {
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
          findHeadersAndProcess(results.data);
        },
        error: function(error) {
          alert('Error al procesar el archivo CSV: ' + error.message);
        }
      });
    }

    function findHeadersAndProcess(rows) {
      if (rows.length < 2) {
        alert('‚ùå El archivo CSV no tiene suficientes datos');
        return;
      }

      let headerRowIndex = -1;
      const headerKeywords = ['fecha', 'fase', 'canal', 'comercial', 'como supo', 'motivo'];

      for (let i = 0; i < Math.min(5, rows.length); i++) {
        const row = rows[i];
        const rowText = row.join(' ').toLowerCase();
        const matchCount = headerKeywords.filter(keyword => rowText.includes(keyword)).length;
        if (matchCount >= 3) {
          headerRowIndex = i;
          break;
        }
      }

      if (headerRowIndex === -1) {
        alert('‚ùå No se pudo detectar la fila de encabezados. Aseg√∫rate de que el CSV contenga columnas como: Fecha, Fase, Canal, Comercial, Motivo.');
        return;
      }

      const headers = rows[headerRowIndex].map(h => (h || '').trim());
      const dataRows = rows.slice(headerRowIndex + 1);

      const data = dataRows
        .map(row => {
          const obj = {};
          headers.forEach((header, idx) => {
            obj[header] = row[idx] || '';
          });
          return obj;
        })
        .filter(row => {
          return Object.values(row).some(val => val.trim() !== '');
        });

      processCSVData(data, headers);
    }

    function processCSVData(data, headers) {
      const colFecha = detectColumn(headers, ['fecha', 'created_at', 'fecha_creacion', 'date']);
      const colCanal = detectColumn(headers, ['canal', 'canal_de_adquisicion', 'como_supo_de_nosotros', 'como supo de nosotros', 'source', 'origen']);
      const colFase = detectColumn(headers, ['fase', 'stage', 'etapa']);
      const colComercial = detectColumn(headers, ['comercial', 'vendedor', 'owner', 'ejecutivo']);
      const colEstatus = detectColumn(headers, ['motivo por que no se concreto', 'motivo_por_que_no_se_concreto', 'estatus', 'status', 'estado']);

      if (!colFecha || !colCanal || !colFase || !colComercial || !colEstatus) {
        const missing = [];
        if (!colFecha) missing.push('Fecha');
        if (!colCanal) missing.push('Canal/Como supo de nosotros');
        if (!colFase) missing.push('Fase');
        if (!colComercial) missing.push('Comercial');
        if (!colEstatus) missing.push('Estatus/Motivo');
        alert(`‚ùå Faltan columnas requeridas:\n\n${missing.join('\n')}\n\nColumnas detectadas:\n${headers.filter(h => h).join(', ')}`);
        return;
      }

      allData = data
        .map(row => {
          const fecha = parseDateFlexible(row[colFecha]);
          if (!fecha) return null;
          return {
            fecha: fecha,
            canal: (row[colCanal] || '').trim() || 'Sin especificar',
            fase: (row[colFase] || '').trim() || 'Sin especificar',
            comercial: (row[colComercial] || '').trim() || 'Sin especificar',
            estatus: normalizeStatus(row[colEstatus])
          };
        })
        .filter(row => row !== null);

      if (allData.length === 0) {
        alert('‚ùå No se encontraron filas v√°lidas en el CSV');
        return;
      }

      initializeFilters();
      applyFilters();
      showDashboard();
    }

    // ============================================================================
    // FILTER MANAGEMENT
    // ============================================================================
    function initializeFilters() {
      currentFilters = {
        canales: new Set(),
        fases: new Set(),
        comerciales: new Set(),
        dateFrom: null,
        dateTo: null
      };

      const canales = [...new Set(allData.map(d => d.canal))].sort();
      const fases = [...new Set(allData.map(d => d.fase))].sort();
      const comerciales = [...new Set(allData.map(d => d.comercial))].sort();

      renderFilterChips('canalFilterList', canales, 'canales');
      renderFilterChips('faseFilterList', fases, 'fases');
      renderFilterChips('comercialFilterList', comerciales, 'comerciales');

      const dates = allData.map(d => d.fecha).sort((a, b) => a - b);
      const minDate = dates[0];
      const maxDate = dates[dates.length - 1];

      document.getElementById('dateFromInput').value = formatDateForInput(minDate);
      document.getElementById('dateToInput').value = formatDateForInput(maxDate);

      currentFilters.dateFrom = minDate;
      currentFilters.dateTo = maxDate;
    }

    function renderFilterChips(containerId, values, filterKey) {
      const container = document.getElementById(containerId);
      container.innerHTML = values.map(value => `
        <button
          class="filter-chip px-3 py-1.5 text-xs font-medium rounded-lg border-2 transition-all glass-card"
          data-filter="${filterKey}"
          data-value="${value}"
          aria-label="Filtrar por ${value}"
        >
          ${value}
        </button>
      `).join('');

      container.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => toggleFilterChip(chip));
      });
    }

    function toggleFilterChip(chip) {
      const filterKey = chip.dataset.filter;
      const value = chip.dataset.value;

      if (currentFilters[filterKey].has(value)) {
        currentFilters[filterKey].delete(value);
        chip.style.background = '';
        chip.style.borderColor = '';
      } else {
        currentFilters[filterKey].add(value);
        chip.style.background = 'linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3))';
        chip.style.borderColor = 'rgba(99, 102, 241, 0.5)';
      }

      applyFilters();
      updateClearButtonVisibility();
    }

    function applyFilters() {
      filteredData = allData.filter(row => {
        if (currentFilters.canales.size > 0 && !currentFilters.canales.has(row.canal)) return false;
        if (currentFilters.fases.size > 0 && !currentFilters.fases.has(row.fase)) return false;
        if (currentFilters.comerciales.size > 0 && !currentFilters.comerciales.has(row.comercial)) return false;
        if (currentFilters.dateFrom && row.fecha < currentFilters.dateFrom) return false;
        if (currentFilters.dateTo && row.fecha > currentFilters.dateTo) return false;
        return true;
      });

      updateDashboard();
    }

    function clearAllFilters() {
      currentFilters.canales.clear();
      currentFilters.fases.clear();
      currentFilters.comerciales.clear();

      const dates = allData.map(d => d.fecha).sort((a, b) => a - b);
      currentFilters.dateFrom = dates[0];
      currentFilters.dateTo = dates[dates.length - 1];

      document.getElementById('dateFromInput').value = formatDateForInput(currentFilters.dateFrom);
      document.getElementById('dateToInput').value = formatDateForInput(currentFilters.dateTo);

      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.style.background = '';
        chip.style.borderColor = '';
      });

      // Reset period filters
      document.querySelectorAll('.period-filter').forEach(btn => {
        btn.classList.remove('border-blue-500/30', 'bg-blue-600/20', 'text-blue-200', 'text-blue-600');
      });
      document.getElementById('periodAll').classList.add('border-blue-500/30', 'bg-blue-600/20', 'text-blue-200');

      applyFilters();
      updateClearButtonVisibility();
    }

    function updateClearButtonVisibility() {
      const hasActiveFilters =
        currentFilters.canales.size > 0 ||
        currentFilters.fases.size > 0 ||
        currentFilters.comerciales.size > 0;

      const btn = document.getElementById('clearFiltersBtn');
      if (hasActiveFilters) {
        btn.classList.remove('hidden');
      } else {
        btn.classList.add('hidden');
      }
    }

    // ============================================================================
    // PERIOD FILTERS
    // ============================================================================
    function applyPeriodFilter(period) {
      if (allData.length === 0) return;

      const now = new Date();
      now.setHours(23, 59, 59, 999);
      let fromDate;

      switch(period) {
        case 'today':
          fromDate = new Date(now);
          fromDate.setHours(0, 0, 0, 0);
          break;
        case '7days':
          fromDate = new Date(now);
          fromDate.setDate(fromDate.getDate() - 7);
          fromDate.setHours(0, 0, 0, 0);
          break;
        case '30days':
          fromDate = new Date(now);
          fromDate.setDate(fromDate.getDate() - 30);
          fromDate.setHours(0, 0, 0, 0);
          break;
        case 'thisMonth':
          fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
          fromDate.setHours(0, 0, 0, 0);
          break;
        case 'all':
          const dates = allData.map(d => d.fecha).sort((a, b) => a - b);
          fromDate = dates[0];
          break;
      }

      currentFilters.dateFrom = fromDate;
      currentFilters.dateTo = now;

      document.getElementById('dateFromInput').value = formatDateForInput(fromDate);
      document.getElementById('dateToInput').value = formatDateForInput(now);

      // Update button styles
      document.querySelectorAll('.period-filter').forEach(btn => {
        btn.classList.remove('border-blue-500/30', 'bg-blue-600/20', 'text-blue-200', 'text-blue-600');
      });
      event.target.classList.add('border-blue-500/30', 'bg-blue-600/20', 'text-blue-200');

      applyFilters();
    }

    // ============================================================================
    // DASHBOARD UPDATE
    // ============================================================================
    function updateDashboard() {
      updateKPIs();
      updateChannelChart();
      updateStatusChart();
      renderInsights();
    }

    function updateKPIs() {
      const total = filteredData.length;
      const concretados = filteredData.filter(d => d.estatus === 'Concretado').length;
      const conversionRate = total > 0 ? ((concretados / total) * 100).toFixed(1) : 0;

      const dates = filteredData.map(d => d.fecha).sort((a, b) => a - b);
      let avgPerDay = 0;
      if (dates.length > 0) {
        const minDate = dates[0];
        const maxDate = dates[dates.length - 1];
        const daysDiff = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1);
        avgPerDay = (total / daysDiff).toFixed(1);
      }

      const totalEl = document.getElementById('kpiTotalLeads');
      const conversionEl = document.getElementById('kpiConversionRate');
      const avgEl = document.getElementById('kpiAvgPerDay');

      animateNumber(totalEl, total);
      conversionEl.textContent = conversionRate + '%';
      avgEl.textContent = avgPerDay;
    }

    function updateChannelChart() {
      const ctx = document.getElementById('channelChart');
      const isDark = document.documentElement.classList.contains('dark');

      const channelCounts = {};
      filteredData.forEach(row => {
        channelCounts[row.canal] = (channelCounts[row.canal] || 0) + 1;
      });

      const sorted = Object.entries(channelCounts).sort((a, b) => b[1] - a[1]);
      const labels = sorted.map(([canal]) => canal);
      const data = sorted.map(([, count]) => count);
      const total = data.reduce((sum, val) => sum + val, 0);

      const colors = [
        '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
        '#3b82f6', '#ef4444', '#14b8a6', '#f97316', '#84cc16'
      ];

      if (charts.channel) charts.channel.destroy();

      charts.channel = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: isDark ? '#1e293b' : '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: { size: 12, family: 'Inter' },
                color: isDark ? '#e2e8f0' : '#334155'
              }
            },
            tooltip: {
              backgroundColor: isDark ? '#1e293b' : '#ffffff',
              titleColor: isDark ? '#ffffff' : '#1e293b',
              bodyColor: isDark ? '#e2e8f0' : '#334155',
              borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
              borderWidth: 1,
              padding: 12,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const count = context.parsed;
                  const percentage = ((count / total) * 100).toFixed(1);
                  return ` ${context.label}: ${count} (${percentage}%)`;
                }
              }
            },
            datalabels: {
              color: '#fff',
              font: { size: 11, weight: 'bold', family: 'Inter' },
              formatter: function(value, context) {
                const percentage = ((value / total) * 100).toFixed(1);
                return `${value}\n${percentage}%`;
              },
              textAlign: 'center'
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function updateStatusChart() {
      const ctx = document.getElementById('statusChart');
      const isDark = document.documentElement.classList.contains('dark');

      const statusOrder = ['Concretado', 'Cancelado', 'Sin respuesta'];
      const statusCounts = {
        'Concretado': 0,
        'Cancelado': 0,
        'Sin respuesta': 0
      };

      filteredData.forEach(row => {
        statusCounts[row.estatus] = (statusCounts[row.estatus] || 0) + 1;
      });

      const labels = statusOrder;
      const data = statusOrder.map(status => statusCounts[status]);

      const colors = {
        'Concretado': '#10b981',
        'Cancelado': '#ef4444',
        'Sin respuesta': '#f59e0b'
      };

      if (charts.status) charts.status.destroy();

      charts.status = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: labels.map(label => colors[label]),
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: {
                color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)',
                drawBorder: false
              },
              ticks: {
                color: isDark ? '#94a3b8' : '#64748b',
                font: { size: 12, family: 'Inter' }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)',
                drawBorder: false
              },
              ticks: {
                color: isDark ? '#94a3b8' : '#64748b',
                font: { size: 12, family: 'Inter' },
                precision: 0
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: isDark ? '#1e293b' : '#ffffff',
              titleColor: isDark ? '#ffffff' : '#1e293b',
              bodyColor: isDark ? '#e2e8f0' : '#334155',
              borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
              borderWidth: 1,
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return ` ${context.parsed.y} leads`;
                }
              }
            },
            datalabels: {
              display: false
            }
          }
        }
      });
    }

    function renderInsights() {
      const insights = [];
      const isDark = document.documentElement.classList.contains('dark');

      const channelCounts = {};
      filteredData.forEach(row => {
        channelCounts[row.canal] = (channelCounts[row.canal] || 0) + 1;
      });
      const topChannel = Object.entries(channelCounts).sort((a, b) => b[1] - a[1])[0];

      if (topChannel) {
        const [canal, count] = topChannel;
        const percentage = ((count / filteredData.length) * 100).toFixed(1);
        insights.push({
          icon: 'üèÜ',
          text: `<strong>${canal}</strong> es el canal con mayor volumen, generando <strong>${count} leads</strong> (${percentage}% del total).`
        });
      }

      const concretados = filteredData.filter(d => d.estatus === 'Concretado').length;
      const conversionRate = filteredData.length > 0
        ? ((concretados / filteredData.length) * 100).toFixed(1)
        : 0;
      insights.push({
        icon: 'üìà',
        text: `La tasa de conversi√≥n actual es del <strong>${conversionRate}%</strong> con <strong>${concretados} leads concretados</strong> de ${filteredData.length} totales.`
      });

      const comercialStats = {};
      filteredData.forEach(row => {
        if (!comercialStats[row.comercial]) {
          comercialStats[row.comercial] = { total: 0, concretados: 0 };
        }
        comercialStats[row.comercial].total++;
        if (row.estatus === 'Concretado') {
          comercialStats[row.comercial].concretados++;
        }
      });

      const topComercial = Object.entries(comercialStats)
        .filter(([name]) => name !== 'Sin especificar')
        .sort((a, b) => b[1].concretados - a[1].concretados)[0];

      if (topComercial) {
        const [name, stats] = topComercial;
        const rate = stats.total > 0 ? ((stats.concretados / stats.total) * 100).toFixed(1) : 0;
        insights.push({
          icon: 'üßë‚Äçüíº',
          text: `<strong>${name}</strong> lidera en concretados con <strong>${stats.concretados} leads</strong> y una tasa de conversi√≥n del ${rate}%.`
        });
      }

      const faseCancelados = {};
      filteredData
        .filter(d => d.estatus === 'Cancelado')
        .forEach(row => {
          faseCancelados[row.fase] = (faseCancelados[row.fase] || 0) + 1;
        });

      const topFaseCancelado = Object.entries(faseCancelados).sort((a, b) => b[1] - a[1])[0];

      if (topFaseCancelado) {
        const [fase, count] = topFaseCancelado;
        const totalCancelados = filteredData.filter(d => d.estatus === 'Cancelado').length;
        const percentage = totalCancelados > 0 ? ((count / totalCancelados) * 100).toFixed(1) : 0;
        insights.push({
          icon: '‚ö†Ô∏è',
          text: `La fase <strong>${fase}</strong> concentra la mayor cantidad de cancelaciones con <strong>${count} leads</strong> (${percentage}% del total cancelado).`
        });
      }

      const container = document.getElementById('insightsList');
      container.innerHTML = insights.map(insight => `
        <li class="flex gap-3 p-4 rounded-xl glass-card hover:scale-[1.01] transition-all duration-200">
          <span class="text-2xl flex-shrink-0">${insight.icon}</span>
          <p class="text-sm leading-relaxed ${isDark ? 'text-gray-300' : 'text-stone-700'}">${insight.text}</p>
        </li>
      `).join('');
    }

    function showDashboard() {
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('dashboardContent').classList.remove('hidden');
      document.getElementById('filtersPanel').classList.remove('hidden');
      lucide.createIcons();
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();

      // Theme toggle
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);

      // File input
      document.getElementById('csvFileInput').addEventListener('change', (e) => {
        handleFileUpload(e.target.files[0]);
      });

      // Upload zone
      document.getElementById('uploadZone').addEventListener('click', () => {
        document.getElementById('csvFileInput').click();
      });

      // Drag & drop
      const uploadZone = document.getElementById('uploadZone');
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.style.transform = 'scale(1.02)';
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.style.transform = '';
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.transform = '';
        handleFileUpload(e.dataTransfer.files[0]);
      });

      // Date range inputs
      document.getElementById('dateFromInput').addEventListener('change', (e) => {
        const date = new Date(e.target.value);
        if (!isNaN(date)) {
          currentFilters.dateFrom = date;
          applyFilters();
        }
      });

      document.getElementById('dateToInput').addEventListener('change', (e) => {
        const date = new Date(e.target.value);
        if (!isNaN(date)) {
          date.setHours(23, 59, 59, 999);
          currentFilters.dateTo = date;
          applyFilters();
        }
      });

      // Clear filters
      document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);

      // Period filters
      document.getElementById('periodToday').addEventListener('click', (e) => applyPeriodFilter('today'));
      document.getElementById('period7Days').addEventListener('click', (e) => applyPeriodFilter('7days'));
      document.getElementById('period30Days').addEventListener('click', (e) => applyPeriodFilter('30days'));
      document.getElementById('periodThisMonth').addEventListener('click', (e) => applyPeriodFilter('thisMonth'));
      document.getElementById('periodAll').addEventListener('click', (e) => applyPeriodFilter('all'));

      lucide.createIcons();
    });
  </script>

</body>
</html>
